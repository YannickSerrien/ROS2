# Lesson 2: Creating a ROS2 Workspace

## Learning Objectives

- Understand ROS2 workspace structure
- Create and organize workspaces
- Build packages with colcon
- Source workspace overlays
- Manage multiple workspaces
- Follow best practices for workspace organization

## What is a ROS2 Workspace?

A **workspace** is a directory containing ROS2 packages. It provides:

- **Isolated environment** for your projects
- **Build system** for compiling code
- **Overlay mechanism** for customization
- **Package organization** structure

```
workspace/
├── src/           # Source code (your packages)
├── build/         # Build artifacts (auto-generated)
├── install/       # Installed executables (auto-generated)
└── log/           # Build logs (auto-generated)
```

## Quick Start

### Create Your First Workspace

```bash
# Create workspace directory
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws

# Build (even though src is empty)
colcon build

# Source the workspace
source install/setup.bash
```

**Note:** For detailed installation and environment setup, see [Module 0: Getting Started](../../00-getting-started/README.md).

## Workspace Anatomy

### The `src/` Directory

Your packages live here:

```
ros2_ws/
└── src/
    ├── my_first_package/
    │   ├── CMakeLists.txt
    │   ├── package.xml
    │   ├── src/
    │   │   └── my_node.cpp
    │   └── include/
    │       └── my_first_package/
    ├── my_second_package/
    │   ├── CMakeLists.txt
    │   ├── package.xml
    │   └── src/
    └── ...
```

### The `build/` Directory (Generated)

Contains intermediate build files:

```
ros2_ws/
└── build/
    ├── my_first_package/
    │   ├── CMakeCache.txt
    │   ├── Makefile
    │   └── ...
    └── ...
```

**Don't edit** - auto-generated by colcon!

### The `install/` Directory (Generated)

Contains installed executables and libraries:

```
ros2_ws/
└── install/
    ├── my_first_package/
    │   ├── lib/
    │   │   └── my_first_package/
    │   │       └── my_node          # Executable!
    │   └── share/
    ├── setup.bash                    # Source this!
    └── ...
```

### The `log/` Directory (Generated)

Build and runtime logs:

```
ros2_ws/
└── log/
    └── build_2024-01-15_10-30-45/
        └── my_first_package/
            └── stdout.log
```

## Creating Packages

### Create C++ Package

```bash
cd ~/ros2_ws/src

# Create package with dependencies
ros2 pkg create --build-type ament_cmake my_cpp_package \
    --dependencies rclcpp std_msgs

# Result:
# my_cpp_package/
# ├── CMakeLists.txt
# ├── package.xml
# ├── src/
# └── include/
#     └── my_cpp_package/
```

### Create Python Package

```bash
ros2 pkg create --build-type ament_python my_py_package \
    --dependencies rclpy std_msgs

# Result:
# my_py_package/
# ├── setup.py
# ├── setup.cfg
# ├── package.xml
# └── my_py_package/
#     └── __init__.py
```

### Package Naming

**Best Practices:**
- Use **lowercase** with underscores
- Be **descriptive**: `robot_controller` not `rc`
- Group related packages: `myrobot_description`, `myrobot_bringup`

```bash
# Good names
ros2 pkg create camera_driver
ros2 pkg create lidar_processor
ros2 pkg create nav_controller

# Bad names
ros2 pkg create Package1      # Not descriptive
ros2 pkg create MyPackage      # Not lowercase
ros2 pkg create p              # Too short
```

## Building Your Workspace

### Basic Build

```bash
cd ~/ros2_ws

# Build all packages
colcon build

# Build specific package
colcon build --packages-select my_package

# Build up to a package (includes dependencies)
colcon build --packages-up-to my_package
```

### Build Options

```bash
# Parallel build (faster)
colcon build --parallel-workers 4

# Symlink install (for Python and resources)
colcon build --symlink-install

# Continue on error
colcon build --continue-on-error

# Verbose output
colcon build --event-handlers console_direct+

# Clean build
colcon build --cmake-clean-cache
```

### Common Build Commands

```bash
# Build only changed packages
colcon build

# Rebuild specific package from scratch
colcon build --packages-select my_package --cmake-clean-cache

# Build with debug symbols
colcon build --cmake-args -DCMAKE_BUILD_TYPE=Debug

# Build with optimizations
colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release
```

## Sourcing Your Workspace

### Source After Building

```bash
# Always source after building
cd ~/ros2_ws
colcon build
source install/setup.bash

# Now you can run your nodes
ros2 run my_package my_node
```

### Shell-Specific Setup Files

```bash
# Bash (most common)
source install/setup.bash

# Zsh
source install/setup.zsh

# Fish
source install/setup.fish

# PowerShell (Windows)
install\setup.ps1
```

### Auto-Source in `.bashrc`

Add to `~/.bashrc` for automatic sourcing:

```bash
# ROS2 Humble
source /opt/ros/humble/setup.bash

# Your workspace
source ~/ros2_ws/install/setup.bash
```

**Reload shell:**
```bash
source ~/.bashrc
```

## Workspace Overlays

### Concept: Layered Workspaces

ROS2 supports **workspace overlays** - multiple workspaces stacked:

```
┌─────────────────────────────┐
│   ~/dev_ws (overlay 2)      │  ← Highest priority
├─────────────────────────────┤
│   ~/ros2_ws (overlay 1)     │
├─────────────────────────────┤
│   /opt/ros/humble (underlay)│  ← Base installation
└─────────────────────────────┘
```

### Creating Overlays

```bash
# Base: ROS2 installation
source /opt/ros/humble/setup.bash

# Overlay 1: Main workspace
cd ~/ros2_ws
colcon build
source install/setup.bash

# Overlay 2: Development workspace
cd ~/dev_ws
colcon build
source install/setup.bash

# Now dev_ws packages override ros2_ws packages
```

### When to Use Overlays

**Use Case 1: Testing Modified Packages**
```bash
# Clone and modify a ROS2 package
cd ~/test_ws/src
git clone https://github.com/ros2/demos

# Build and overlay
cd ~/test_ws
colcon build
source install/setup.bash

# Your modified version now takes priority
```

**Use Case 2: Project Separation**
```bash
# Workspace per project
~/robot_project_ws/
~/simulation_ws/
~/research_ws/
```

## Multiple Workspaces

### Workspace Per Project

```bash
# Project 1
mkdir -p ~/project1_ws/src
cd ~/project1_ws
colcon build

# Project 2
mkdir -p ~/project2_ws/src
cd ~/project2_ws
colcon build

# Switch between projects
source ~/project1_ws/install/setup.bash  # Use project 1
source ~/project2_ws/install/setup.bash  # Use project 2
```

### Workspace Switching Script

Create `~/switch_ws.sh`:

```bash
#!/bin/bash

case $1 in
    project1)
        source ~/project1_ws/install/setup.bash
        echo "Switched to project1_ws"
        ;;
    project2)
        source ~/project2_ws/install/setup.bash
        echo "Switched to project2_ws"
        ;;
    *)
        echo "Usage: source switch_ws.sh [project1|project2]"
        ;;
esac
```

**Usage:**
```bash
source ~/switch_ws.sh project1
```

## Workspace Best Practices

### DO ✓

```bash
# Always build from workspace root
cd ~/ros2_ws
colcon build

# Source after every build
colcon build && source install/setup.bash

# Use package-select for faster iteration
colcon build --packages-select my_package

# Keep src/ under version control
cd src/
git init
git add my_packages/
git commit -m "Initial commit"

# Use symlink-install for Python
colcon build --symlink-install
```

### DON'T ✗

```bash
# Don't build from src/
cd ~/ros2_ws/src
colcon build  # Wrong!

# Don't version control build/, install/, log/
git add build/  # Bad!
git add install/  # Bad!

# Don't forget to source
colcon build
ros2 run my_package my_node  # Won't find it!

# Don't mix build types without cleaning
colcon build
colcon build --cmake-args -DCMAKE_BUILD_TYPE=Debug  # Clean first!
```

### .gitignore for Workspaces

Create `~/ros2_ws/.gitignore`:

```gitignore
# Ignore colcon-generated directories
build/
install/
log/

# Keep source code
!src/
```

## Cleaning Your Workspace

### Remove Build Artifacts

```bash
# Remove all generated files
cd ~/ros2_ws
rm -rf build/ install/ log/

# Rebuild from scratch
colcon build
```

### Clean Specific Package

```bash
# Remove package build
rm -rf build/my_package install/my_package

# Rebuild package
colcon build --packages-select my_package
```

## Common Workspace Patterns

### Pattern 1: Single Workspace

```bash
# All your packages in one workspace
~/ros2_ws/
└── src/
    ├── package1/
    ├── package2/
    └── package3/
```

✓ Simple, easy to manage
✗ Large builds

### Pattern 2: Multiple Workspaces

```bash
# Separate workspaces per project
~/robot1_ws/
~/robot2_ws/
~/simulation_ws/
```

✓ Isolated projects
✗ More management overhead

### Pattern 3: Overlay for Development

```bash
# Stable packages
~/stable_ws/

# Development overlay
~/dev_ws/
```

✓ Test changes without affecting stable code
✗ Need to manage multiple workspaces

## Verifying Your Workspace

### Check Package Visibility

```bash
# Source workspace
source ~/ros2_ws/install/setup.bash

# List packages
ros2 pkg list | grep my_package

# List executables
ros2 pkg executables my_package

# Check package path
ros2 pkg prefix my_package
```

### Test Package Build

```bash
# Build package
colcon build --packages-select my_package

# Check for errors in log
cat log/latest_build/my_package/stdout.log
```

## Environment Variables

### Key ROS2 Variables

```bash
# After sourcing workspace
echo $ROS_DISTRO        # humble
echo $AMENT_PREFIX_PATH # Workspace paths
echo $CMAKE_PREFIX_PATH # CMake paths

# Check all ROS2 variables
env | grep ROS
```

### Setting Custom Variables

```bash
# In ~/.bashrc
export ROS_DOMAIN_ID=42          # Multi-robot isolation
export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp  # DDS vendor
export RCUTILS_CONSOLE_OUTPUT_FORMAT="[{severity}] [{name}]: {message}"
```

## Advanced Workspace Topics

### Mixing Build Types

```bash
# C++ packages (ament_cmake)
# Python packages (ament_python)
# Both can coexist in same workspace!

ros2_ws/
└── src/
    ├── cpp_package/     # C++
    └── py_package/      # Python
```

### Dependencies Between Packages

```bash
# If package_b depends on package_a
ros2_ws/
└── src/
    ├── package_a/
    └── package_b/  # Lists package_a in package.xml

# Build with dependencies
colcon build --packages-up-to package_b
```

## Troubleshooting

### Issue 1: Command Not Found

**Problem:**
```bash
ros2 run my_package my_node
# Package 'my_package' not found
```

**Solution:**
```bash
# Source workspace!
source ~/ros2_ws/install/setup.bash
```

### Issue 2: Build Fails

**Problem:**
```bash
colcon build
# CMake Error: ...
```

**Solution:**
```bash
# Check log
cat log/latest_build/my_package/stdout_stderr.log

# Clean and rebuild
rm -rf build/ install/
colcon build
```

### Issue 3: Old Version Running

**Problem:**
```bash
# Made changes, rebuilt, but old version runs
```

**Solution:**
```bash
# Re-source after building!
colcon build
source install/setup.bash
ros2 run my_package my_node  # Now uses new version
```

## Quick Reference

### Workspace Creation
```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws
colcon build
source install/setup.bash
```

### Package Creation
```bash
cd ~/ros2_ws/src
ros2 pkg create --build-type ament_cmake my_package \
    --dependencies rclcpp std_msgs
```

### Build Commands
```bash
colcon build                              # Build all
colcon build --packages-select pkg        # Build one
colcon build --packages-up-to pkg         # Build with deps
colcon build --symlink-install            # Python dev mode
```

### Source Commands
```bash
source install/setup.bash                 # Source workspace
source /opt/ros/humble/setup.bash         # Source ROS2
```

## Summary

**Key Takeaways:**
- Workspaces organize ROS2 packages
- `src/` contains source code, `install/` contains built executables
- Always build from workspace root with `colcon build`
- Source workspace after building: `source install/setup.bash`
- Use overlays for testing and development
- Keep `build/`, `install/`, `log/` out of version control

**Critical Commands:**
```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws
colcon build
source install/setup.bash
ros2 run my_package my_node
```

## Practice Exercise

Create a workspace with:
1. Two C++ packages: `talker` and `listener`
2. Build both packages
3. Verify executables are created
4. Create a `.gitignore` for the workspace
5. Practice sourcing and unsourcing

## What's Next?

- **Next Lesson**: [Your First Node](03-first-node.md)
- **Reference**: [Module 0: Workspace Guide](../../00-getting-started/ros2-workspace-guide.md)
- **Build System**: [Module 1: Build Systems](../../01-cpp-refresher/lessons/10-build-systems.md)

---

**You now know how to organize ROS2 projects!** Time to create your first node.
